<template>
	<div class="wrapper">
		<i class="search iconzuojiantou" @click="goBack" />
		<input
			class="searchInp"
			type="text"
			placeholder
			ref="inp"
			v-model.trim="keywords"
			@focus="displayList"
		/>
		<i class="search iconsousuo1" />
		<div class="floatInfo" v-if="showList">
			<ul>
				<li @click="searchKey(keywords)" class="blue border-bottom">
					搜索
					<span class="text">"{{ keywords }}"</span>
				</li>
				<li
					@click="searchKey(item.keyword)"
					class="border-bottom"
					v-for="(item, index) in searchList"
					:key="index"
				>
					<i class="search iconsousuo" />
					{{ item.keyword }}
				</li>
			</ul>
		</div>
		<div class="mask" v-show="showList" @click="hideList" />
	</div>
</template>

<script>
import API from '@api';
import Bus from '@utils/Bus';
export default {
	name: 'Search',
	data() {
		return {
			searchList: [],
			default: '',
			keywords: '',
			showList: false,
			history: []
		};
	},
	watch: {
		/**
		 * 是否显示搜索建议
		 */
		keywords: function(val, oldVal) {
			if (this.keywords.length > 0) {
				this.displayList();
				this.setSearchList(val);
			} else {
				this.hideList();
			}
		}
	},
	created() {
		this.getFocus();
		// 先将默认搜索建议显示
		this.setDefault();
		this.getHistory();
	},

	methods: {
		/**
		 * 自动获取焦点
		 */
		getFocus() {
			this.$nextTick(x => {
				this.$refs.inp.focus();
			});
		},

		/**
		 * 返回上一页
		 */
		goBack() {
			this.$router.go(-1);
		},

		/**
		 * 设置输入框的默认显示
		 */
		setDefault() {
			API.getDefaultSearch().then(res => {
				const data = res.data;
				if (data.code === 200) {
					this.default = data.data.showKeyword;
					this.$refs.inp.setAttribute('placeholder', this.default);
				}
			});
		},

		/**
		 * 隐藏搜索建议列表
		 */
		hideList() {
			this.showList = false;
		},

		/**
		 * 显示搜索列表建议
		 */
		displayList() {
			// 当搜索框内没有内容时不显示
			if (!this.keywords) {
				return;
			}
			this.showList = true;
		},

		/**
		 * 根据搜索内容展示搜索建议列表
		 */
		setSearchList(keywords) {
			API.getSuggestSearch(keywords).then(res => {
				const data = res.data;
				if (data.code === 200) {
					this.searchList = data.result.allMatch;
				}
			});
		},

		/**
		 * 获取历史搜索记录
		 */
		getHistory(key) {
			let keys = localStorage.getItem('keys')
				? localStorage.getItem('keys').split(',')
				: [];
			if (key) {
				// 将关键字插入到数组最前面
				keys.unshift(key);
				// 存入本地之前进行去重
				keys = this.unique(keys);
				// 存入本地
				localStorage.setItem('keys', keys);
			}
			this.history = keys;
			// 通过Bus 进行兄弟组件之间传值
			// 通过 Bus.$emit('方法名',要传的值)
			Bus.$emit('history', this.history);
		},

		/**
		 * 搜索
		 */
		searchKey(key) {
			this.getHistory(key);
			API.getSearchList(key).then(res => {
				const data = res.data;
				if (data.code === 200) {
					console.log(data);
				}
			});
		},

		/**
		 * 数组去重
		 */
		unique(arr) {
			if (!Array.isArray(arr)) {
				console.log('type error!');
				return;
			}
			return Array.prototype.filter.call(arr, function(item, index) {
				return arr.indexOf(item) === index;
			});
		}
	}
};
</script>

<style lang="less" scoped>
// @import url('~styles/global.less');
.wrapper {
	// .flex-between();
	display: flex;
	justify-content: space-between;
	.search {
		font-size: 5vw;
	}
	.searchInp {
		flex: 1;
		margin: 0 0.3rem;
		border-bottom: 1px solid #aaa;
	}
	.floatInfo {
		width: 5.7rem;
		position: absolute;
		top: 0.8rem;
		box-shadow: 0 4px 16px #aaa;
		background-color: #fff;
		z-index: 2;
		// .pd23();
		li {
			height: 0.8rem;
			line-height: 0.8rem;
			color: #888;
			.text {
				margin-left: 8px;
			}
			.search {
				font-size: 0.4rem;
				vertical-align: -0.04rem;
			}
		}
		.blue {
			color: #38f;
		}
	}
	.mask {
		position: fixed;
		top: 0;
		left: 0;
		bottom: 0;
		right: 0;
		z-index: 1;
	}
}
</style>
